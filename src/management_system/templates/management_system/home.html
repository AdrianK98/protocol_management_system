{% extends 'main.html' %}


{% block content %}


<h1>Strona startowa</h1>
<hr />

<section id="main_panel">
	<section class="panel-pad" id="protocols">
		<section class="panel fill">
			<h2 class="panel-title">Ostatnie protoko≈Çy</h2>
			<section class="panel-cnt" id="protocols_cnt"></section>
		</section>
	</section>
	<section id="panel_grp">
		<section class="panel-pad" id="alerts">
			<section class="panel  fill">
				<h2 class="panel-title">Powiadomienia</h2>
				<section class="panel-cnt"></section>
			</section>
		</section>
		<section class="panel-pad" id="last_added">
			<section class="panel fill">
				<h2 class="panel-title">Ostatnio dodane przedmioty</h2>
				<section class="panel-cnt" id="last_added_cnt"></section>
			</section>
		</section>
	</section>
</section>

<style>
@media (min-width:1150px){
	#main_panel{
		height: calc(100% - 5rem);
	}

	#protocols{
		height: 100%;
		width: 50%;
		float: left;
	}

	#panel_grp{
		height: 100%;
		width: 50%;
		float: left;
	}
	
	#alerts{
		height: 50%;
		width: 100%;
	}
	
	#last_added{
		height: 50%;
		width: 100%;
	}
}

@media (max-width:1150px){
	#main_panel{
		height: calc(100% - 5rem);
	}

	#protocols{
		height: 100%;
		width: 100%;
	}
	
	#panel_grp{
		height: 100%;
		width: 100%;
	}

	#alerts{
		height: 50%;
		width: 100%;
	}
	
	#last_added{
		height: 50%;
		width: 100%;
	}
}

.panel-cnt{
	overflow: auto;
}
</style>

<script>
	// Like Date.toDateString() but custom (shorter)
function dtos(date) {
    let day = date.getDate();
    let month = date.getMonth() + 1; // Months are zero-based
    let year = date.getFullYear();
    let hours = date.getHours();
    let minutes = date.getMinutes();
    
    // Add leading zeros to day, month, hours, and minutes if necessary
    if (day < 10) day = '0' + day;
    if (month < 10) month = '0' + month;
    if (hours < 10) hours = '0' + hours;
    if (minutes < 10) minutes = '0' + minutes;
    
    return `${day}.${month}.${year} ${hours}:${minutes}`; // Format: DD-MM-YYYY HH:MM
}

	$(document).ready(async function(){
		// Create table in protocols
		let protocols_cnt = document.getElementById('protocols_cnt');
		let protocols_table = document.createElement('table');
		protocols_table.innerHTML = "<tr><th scope=\"col\">Kod</th><th scope=\"col\">Data</th><th scope=\"col\">Pracownik</th><th scope=\"col\">Typ</th><!--<th class=\"w-0\" scope=\"col\"></th>--></tr>";
		protocols_table.classList = "table";
		protocols_cnt.appendChild(protocols_table);

		// Fetch data from server using API2
		let protocols_data = await fetch("{% url 'protocol-list' %}?limit=19&region={{request.user.userinfo.region.id}}");
		let protocols = await protocols_data.json();
		protocols = protocols.results;

		// For each element
		for(let protocol of protocols){
			// Prepare date
			let protocol_date = new Date(protocol.created);

			// Prepare table row
			let row = "";
			row += "<tr>";
			row += "<td><a href=\"/protocols/" + protocol.id + "\">" + protocol.barcode + "</a></td>";
			row += "<td>" + dtos(protocol_date) + "</td>";
			row += "<td>" + protocol.employee.user_name + ' ' + protocol.employee.user_surname + "</td>";
			row += "<td>" + (protocol.is_return?"Zwrot":"Przekazanie") + "</td>";
			//row += "<td><a href=\"/protocols/" + e.id + "\" role=\"button\" class=\"btn btn-success\">Wyswietl</a></td>";
			row += "</tr>";

			//Append row
			protocols_table.innerHTML += row;
		}

		// Create table in last_added
		let last_added_cnt = document.getElementById('last_added_cnt');
		let last_added_table = document.createElement('table');
		last_added_table.innerHTML = "<tr><th scope=\"col\">IT</th><th scope=\"col\">Data</th><th scope=\"col\">Producent</th><th scope=\"col\">Typ</th></tr>";
		last_added_table.classList = "table";
		last_added_cnt.appendChild(last_added_table);

		// Fetch data from server using API2
		let last_added_items_data = await fetch("{% url 'item-list' %}?limit=8&region={{request.user.userinfo.region.id}}");
		let last_added_items = await last_added_items_data.json();
		last_added_items = last_added_items.results;

		// For each element
		for(let item of last_added_items){
			// Prepare date
			let protocol_date = new Date(item.created);
			// Prepare table row
			let row = "";
			row += "<tr>";
			row += "<td><a href=\"/items/" + item.id + "\">" + (item.item_it ? item.item_it : "Brak numeru IT") + "</a></td>";
			row += "<td>" + dtos(protocol_date) + "</td>";
			row += "<td>" + item.item_producent + "</td>";
			row += "<td>" + item.category.category_name + "</td>";
			row += "</tr>";

			//Append row
			last_added_table.innerHTML += row;
		}

	});
</script>

{% endblock content %}
